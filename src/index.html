<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>MySQL Document Store and Node.JS</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<link rel="stylesheet" href="css/reveal-orcl-override.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-background="images/mysql_bg.jpg" class="mysql-full">MySQL Document Store</section>
				<section>
					<!-- ~5 minutes -->
					<p>Welcome, who are we?</p>
					<table><!-- Yay I'm still a table fan, yes, I'm stuck in HTML 3 :-D -->
						<!-- Stackoveflow uses typical CSS stuff: https://stackoverflow.com/questions/30861845/how-to-use-two-column-layout-with-reveal-js -->
						<tr>
							<td><!-- img src="" --> Johannes Schlüter</td>
							<td><!-- img src="" --> Rui Quelhas</td>
						</tr>
					</table>
					<aside class="notes">
						Also point to MySQLers in audience!
						<ul>
							<li>Geir? - Server lead</li>
							<li>Jan? - DocStore Architect, Server Plugin lead</li>
							<li>LeFred? - Community, InnoDB Cluster expert</li>
							<li>Others!</li>
						</ul>
						All questions could be answered ;-)
					</aside>
				</section>
				<section>
					<!-- Johannes: -->
					<!-- ~5 minutes -->
					<h2>Unstructured Data</h2>
					<section>
						<p>Not only relational data</p>
						<ul>
							<li>Often data of unstructured nature<!-- TODO:Johannes repeating myself from header ....--></li>
							<li>Data from external sources</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Let's take a look at some samples from OpenStreetmap</li>
							</ul>
						</aside>
					</section>
					<section>
						<pre>
							<code class="js" data-trim data-noescape>
{
  "type": "node",
  "id": 205225934,
  "lat": 53.3809524,
  "lon": -6.2456914,
  "tags": {
    "amenity": "pub",
    "name": "The Viscount"
  }
}
							</code>
						</pre>
						<aside class="notes">
							<ul>
								<li>This is a <i>node</i>, one of the building blocks in OpenStreetmap, a <i>node</i> has an <i>id</i>, geo location and a set of arbitrary tags</li>
								<li>This specific node is a pub and has a name</li>
							</ul>
						</aside>
					</section>
					<section>
						<pre>
							<code class="js" data-trim data-noescape>
{
  "type": "node",
  "id": 130156802,
  "lat": 53.3500620,
  "lon": -6.2526730,
  "tags": {
    "addr:city": "Dublin",
    "addr:country": "IE",
    "addr:housenumber": "21",
    "addr:street": "Store Street",
    "amenity": "pub",
    "name": "Le Monde",
    "wheelchair": "no"
  }
}
							</code>
						</pre>
						<aside class="notes">
							<ul>
								<li>This pub <i>node</i>, contains more data</li>
							</ul>
						</aside>
					</section>
					<section>
						<pre>
							<code class="js" data-trim data-noescape>
{
  "type": "node",
  "id": 132186038,
  "lat": 53.2747643,
  "lon": -6.2545959,
  "tags": {
    "amenity": "pub",
    "name": "The Ballinteer House",
    "wheelchair": "limited"
  }
}
							</code>
						</pre>
					</section>
					<section>
						<pre>
							<code class="js" data-trim data-noescape>
{
  "type": "node",
  "id": 132775981,
  "lat": 53.3441892,
  "lon": -6.2490239,
  "tags": {
    "accommodation": "yes",
    "addr:city": "Dublin",
    "addr:country": "IE",
    "addr:housenumber": "1",
    "addr:street": "Lombard Street East",
    "amenity": "pub",
    "name": "The Lombard",
    "opening_hours": "Mo-Th 09:00-23:30;Fr-Sa 09:30-01:30;Su 10:00-23:00",
    "source": "visually identified"
  }
}
							</code>
						</pre>
						<aside class="notes">
							<p>Last one!</p>
							<p>Other data might of course be way more different</p>
						</aside>
					</section>
					<section>
						<p>JSON data type</p>
						<ul>
							<li>Introduced in MySQL 5.7</li>
							<li>Efficient storage</li>
							<li>Set of functions to create, modify and access elements</li>
							<li>Generated columns allow indexing parts of a document</li>
						</ul>
					</section>
					<section>
						TODO:Johannes Show pure SQL access ...
					</section>
				</section>
				<section>
					<!-- Johannes: -->
					<!-- ~5 minutes -->
					<h2>MySQL Document Store</h2>
					<section>Introduced with 5.7.?, new protocol, common set of APIs</section>
					<section>MySQL Shell</section>
					<section>Support for C++, Java, .Net (C# etc.), Python, PHP</section>
					<section>Terms to clarify in this section: Collection, Document, ...</section>
				</section>
				<section>
					<!-- Johannes: -->
					<!-- ~5 minutes -->
					<h2>X Protocol</h2>
					<section>
						<p>Protocol Insights</p>
						<ul>
							<li>New Protocol implemented in X Plugin</li>
							<li>Based on Google Protocol Buffers
								<ul>
									<li>More flexibility for future extensions</li>
								</ul>
							</li>
							<li>Better understanding of content
								<ul>
								<li>CRUD Expression trees in protocol</li>
								<li>Expectations to attach conditions on pipelined statements</li>
								<li>Bound parameters</li>
								</ul>
							</li>
						</ul>
						<aside class="notes">
							<ul>
								<li>Initially shipped as <i>rapid</i> plugin in MySQL 5.7.12</li>
								<li>Google Protobuf is an industry standard data serialisation library</li>
								<li>Middleware can use more information</li>
							</ul>
						</aside>
					</section>
					<section>
						<p>Protocol operations</p>
						<!-- TODO:Johannes shorten, or not? -->
						<pre><code data-trim data-noescape>
message ClientMessages {
  enum Type {
    CON_CAPABILITIES_GET = 1;
    CON_CAPABILITIES_SET = 2;
    CON_CLOSE = 3;

    SESS_AUTHENTICATE_START = 4;
    SESS_AUTHENTICATE_CONTINUE  = 5;
    SESS_RESET = 6;
    SESS_CLOSE = 7;

    SQL_STMT_EXECUTE = 12;

    CRUD_FIND = 17;
    CRUD_INSERT = 18;
    CRUD_UPDATE = 19;
    CRUD_DELETE = 20;

    EXPECT_OPEN = 24;
    EXPECT_CLOSE = 25;

    CRUD_CREATE_VIEW = 30;
    CRUD_MODIFY_VIEW = 31;
    CRUD_DROP_VIEW = 32;
  }
}
						</code></pre>
					</section>
					<section>
						<p>CRUD Example</p>
						<!-- TODO:Johannes shorten, or not? -->
						<pre><code data-trim data-noescape>
Mysqlx.Crud.Find {
  collection { name: "collection_name",  schema: "test"  }
  data_model: DOCUMENT
  criteria {
    type: OPERATOR
    operator {
      name: "=="
      param { type: IDENT,   identifier { name:"_id" }  }
      param { type: LITERAL, literal { type: V_STRING,
                                       v_string: { value: "some_string" } } }
    }
  }
}
							</code>
						</pre>
					</section>
				</section>
				<section>
					<!-- Rui: -->
					<!-- ~5 minutes -->
					<h2>Node.js</h2>
					<section id="nodejs-intro">
						<p>(straight) from the <a href="https://nodejs.org/en/">horse's mouth</a></p>
						<blockquote cite="https://nodejs.org/en/">
							Node.js® is a JavaScript runtime built on Chrome's V8 JavaScript engine.
							Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient.
							Node.js' package ecosystem, npm, is the largest ecosystem of open source libraries in the world.
						</blockquote>
					</section>
					<section id="nodejs-overview">
						<p class="list-header">Overview</p>
						<ul>
							<li>Asynchronous event driven JavaScript server runtime</li>
							<li>Non-blocking IO through the <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ">event loop</a></li>
							<li>HTTP as a first-class citizen</li>
							<li>Filesystem, OS, network (TCP/UDP) and TLS</li>
							<li>Out-of-the box streaming APIs</li>
							<li>Bindings for C/C++ native addons</li>
							<li>Unified module system and package manager (npm)</li>
						</ul>
					</section>
					<section id="nodejs-programming-model">
						<p class="list-header">Programming model</p>
						<ul>
							<li>Single-threaded environment (it's JavaScript after all)</li>
							<li>Asynchronous callback-based at its core</li>
							<li>Non-blocking (CPU-bound tasks, memory access, etc.) operations executed sequentially</li>
							<li>Blocking (network/disk access, etc.) operations queued outside execution scope</li>
							<li>Result of a blocking operation is handled "eventually"</li>
							<li>Concurrency achieved through V8 (threading) or multiple processes</li>
						</ul>
					</section>
					<section id="nodejs-dealing-with-asynchronicity">
						<p class="list-header">Dealing with asynchronicity</p>
						<ul>
							<li>
								Push-based abstractions for asynchronous callbacks:
								<ul>
									<li>Event emitters</li>
									<li>Streams (special kind of event emitters)</li>
									<li>Promises</li>
								</ul>
							</li>
							<li>
								Pull-based abstractions for asynchronous callbacks:
								<ul>
									<li>Generators</li>
									<li>Async/await</li>
								</ul>
							</li>
							<li>Many other userland experiments of both kinds</li>
						</ul>
					</section>
					<section id="nodejs-callbacks">
						<p>Callback pattern</p>
						<pre>
							<code class="js" data-trim data-noescape>
							const asyncFn = (success, callback) => {
							  setTimeout(() => {
							    if (!success) return callback(new Error('bar'))
							    callback(null, 'foo')
							  }, 1000);
							}

							asyncFn(true, (err, data) => {
							  console.log(data) // foo
							})

							asyncFn(false, (err) => {
							  console.log(err.message) // bar
							})
							</code>
						</pre>
					</section>
					<section id="nodejs-push-event-emitter">
						<p>Event emitter</p>
						<pre>
							<code class="js" data-trim data-noescape>
							const emitter = new EventEmitter()

							emitter.on('someEvent', message => {
							  console.log(message) // foo
							})

							emitter.emit('someEvent', 'foo')
							</code>
						</pre>
					</section>
					<section id="nodejs-push-stream">
						<p>Streams</p>
						<pre>
							<code class="js" data-trim data-noescape>
							const readable = new Stream.Readable()
							const writable = new Stream.Writable()

							readable.on('data', data => {
							  console.log(data) // foo
							})

							readable.pipe(writable)
							writable.write('foo')
							</code>
						</pre>
					</section>
					<section id="nodejs-push-promise">
						<p>Promises</p>
						<pre>
							<code class="js" data-trim data-noescape>
							const promise1 = Promise.resolve('foo')
							const promise2 = Promise.reject(new Error('bar'))

							promise1.then(data => {
							  console.log(data) // foo
							})

							promise2.catch(err => {
							  console.log(err.message) // bar
							})
							</code>
						</pre>
					</section>
					<section id="nodejs-pull-generators">
						<p>Generators</p>
						<pre>
							<code class="js" data-trim data-noescape>
							const gen = function * () {
							  yield 'foo'
							  return 'bar'
							}

							console.log(gen.next()) // { value: 'foo', done: false }
							console.log(gen.next()) // { value: 'bar', done: true }
							</code>
						</pre>
					</section>
					<section id="nodejs-pull-async-await">
						<p>Async/await</p>
						<pre>
							<code class="js" data-trim data-noescape>
							const promise1 = Promise.resolve('foo')
							const promise2 = Promise.reject(new Error('bar'))

							try {
							  console.log(await promise1) // 'foo'
							  await promise2
							} catch (err) {
							  console.log(err.message) // 'bar'
							}
							</code>
						</pre>
					</section>
				</section>
				<section>
					<!-- Rui: -->
					<!-- ~15 minutes -->
					<h2>MySQL Connector/Node.js</h2>
					<section id="cnodejs-overview">
						<p class="list-header">Overview</p>
						<ul>
							<li>Official implementation</li>
							<li>Based on the brand new X protocol</li>
							<li>Asynchronous and <span class="inline">Promise</span>-based</li>
							<li>Supports <span class="inline">async/await</span></li>
							<li>Fluent/chainable API (out-of-the-box query builder)</li>
							<li>Flexible parameter methods</li>
						</ul>
					</section>
					<section id="cnodejs-features">
						<p class="list-header">Some features</p>
						<ul>
							<li>Document store CRUD API</li>
							<li>Relational CRUD API</li>
							<li>Fallback to plain old SQL</li>
							<li>Transactions and row locking</li>
							<li>Secure sessions (SSL/TLS)</li>
							<li>Authentication</li>
							<li>Configuration handling interface</li>
						</ul>
					</section>
					<section id="cnodejs-features-fluent-api">
						<p>Fluent API (Document Store)</p>
						<pre>
							<code class="js" data-trim data-noescape>
								collection.add({ name: 'foo' }).add({ name: 'bar' }).execute()

								collection.find('$.name == :name').bind(name, 'foo').execute()

								collection.modify('$.name == "foo"').set('$.name', 'qux').execute()

								collection.remove('$.name == "bar"').execute()
							</code>
						</pre>
					</section>
					<section id="cnodejs-features-fluent-api-interface">
						<p>Database operations</p>
						<pre>
							<code class="js" data-trim data-noescape>
							// CollectionAdd
							const addOperation = collection.add()

							// CollectionFind
							const findOperation = collection.find()

							// CollectionModify
							const modifyOperation = collection.modify()

							// CollectionRemove
							const removeOperation = collection.remove()
							</code>
						</pre>
					</section>
					<section id="cnodejs-features-fluent-api-add-ebnf">
						<p><span class="inline">CollectionAdd</span></p>
						<img class="ebnf" src="images/collectionadd.png" alt="CollectionAdd EBNF">
					</section>
					<section id="cnodejs-features-fluent-api-find-ebnf">
						<p><span class="inline">CollectionFind</span></p>
						<img class="ebnf" src="images/collectionfind.png" alt="CollectionFind EBNF">
					</section>
					<section id="cnodejs-features-fluent-api-modify-ebnf">
						<p><span class="inline">CollectionModify</span></p>
						<img class="ebnf" src="images/collectionmodify.png" alt="CollectionModify EBNF">
					</section>
					<section id="cnodejs-features-fluent-api-remove-ebnf">
						<p><span class="inline">CollectionRemove</span></p>
						<img class="ebnf" src="images/collectionremove.png" alt="CollectionRemove EBNF">
					</section>
					<section id="cnodejs-features-sql-fallback">
						<p>Fallback to plain-old SQL</p>
						<pre>
							<code class="js" data-trim data-noescape>
							// insert document into a collection
							session.sql(`INSERT INTO collection (doc) values ('{"_id":"foo","name":"bar"}')`)
							  .execute()

							// project "name" property values
							session.sql(`SELECT JSON_EXTRACT(doc, '$.name') FROM collection`)
							  .execute()

							// create a virtual column and use it as an index
							session.sql(`ALTER TABLE collection ADD COLUMN name TEXT(3) GENERATED ALWAYS AS
							    (JSON_EXTRACT(doc, '$.name')) VIRTUAL, ADD INDEX i_name (name)`)
							  .execute()
							</code>
						</pre>
					</section>
					<section id="cnodejs-features-async">
						<p>Asynchronous API <=> <span class="inline">Promise</span></p>
						<ul>
							<li><span class="inline">getSession()</span></li>
							<li><span class="inline">createSchema()</span></li>
							<li><span class="inline">dropSchema()</span></li>
							<li><span class="inline">createCollection()</span></li>
							<li><span class="inline">dropCollection()</span></li>
							<li><span class="inline">execute()</span></li>
							<li>&hellip;</li>
						</ul>
					</section>
					<section id="cnodejs-features-cursors">
						<p>Simple push-based "cursors"</p>
						<pre>
							<code class="js" data-trim data-noescape>
							// the cursor gets executed for each element of the result set
							function cursor (p) {
							  // p: result set element currently being processed
							}

							collection.find().execute(cursor)
							</code>
						</pre>
					</section>
					<section id="cnodejs-features-completion">
						<p>Operation completion</p>
						<pre>
							<code class="js" data-trim data-noescape>
							collection
							  .find()
							  .execute()
							  .then(function (r) {
							    // r: instance of Result (coming up next)
							  })
							  .catch(function (e) {
							    // e: instance of Error
							  })
							</code>
						</pre>
					</section>
					<section id="cnodejs-features-results">
						<p><span class="inline">Result</span></p>
						<ul>
							<li><span class="inline">getDocumentId()</span></li>
							<li><span class="inline">getDocumentIds()</span></li>
							<li><span class="inline">getAffectedRowsCount()</span></li>
							<li><span class="inline">getWarnings()</span></li>
							<li><span class="inline">getWarningsCount()</span></li>
							<li>&hellip;</li>
						</ul>
					</section>
				</section>
				<section>
					<h2>Putting everything together</h2>
					<section id="cnodejs-snippet-boilerplate">
						<p>Boilerplate (sessions and schemas)</p>
						<pre>
							<code class="js" data-trim data-noescape>
								const mysqlx = require('@mysql/xdevapi')

								const session = await mysqlx.getSession('mysqlx://demo@localhost:33060')

								// re-create the schema
								await session.dropSchema('ple2017')
								const schema = await session.createSchema('ple2017')
							</code>
						</pre>
					</section>
					<section id="cnodejs-snippet-crud">
						<p>Working with collections and documents (<b class="orcl-red">CRUD</b>)</p>
						<pre>
							<code class="js" data-trim data-noescape>
								const schema = session.getSchema('ple2017')

								// re-create a collection
								await schema.dropCollection('demo')
								await schema.createCollection('demo')

								// or re-use an existing collection
								const collection = schema.createCollection('demo', { ReuseExistingObject: true })
							</code>
						</pre>
					</section>
					<section id="cnodejs-snippet-create">
						<p><b class="orcl-red">C</b>REATE</p>
						<pre>
							<code class="js" data-trim data-noescape>
							const collection = schema.getCollection('demo')

							// pipelining parallel calls
							await Promise.all([
							  collection.add({ name: 'foo' }).execute(),
							  collection.add([{ name: 'bar' }, { name: 'baz' }]).execute()
							])
							</code>
						</pre>
					</section>
					<section id="cnodejs-snippet-read">
						<p><b class="orcl-red">R</b>EAD</p>
						<pre>
							<code class="js" data-trim data-noescape>
								const collection = schema.getCollection('demo')
								const docs = []

								await collection
								  .find()
								  .execute(doc => doc && docs.push(doc))

								console.log(docs) // [{ name: 'foo' }, { name: 'bar' }, { name: 'baz' }]
							</code>
						</pre>
					</section>
					<section id="cnodejs-snippet-update">
						<P><b class="orcl-red">U</b>PDATE</P>
						<pre>
							<code class="js" data-trim data-noescape>
								const collection = schema.getCollection('demo')
								const docs = []

								await collection
								  .modify('$.name == "foo"')
								  .set('name', 'qux')
								  .set('oldName', 'foo')
								  .execute()

								await collection
								  .find()
								  .execute(doc => doc && docs.push(doc))

								console.log(docs) // [{ name: 'qux', oldName: 'foo' }, { name: 'bar' }, ... ]
							</code>
						</pre>
					</section>
					<section id="cnodejs-snippet-delete">
						<p><b class="orcl-red">D</b>ELETE</p>
						<pre>
							<code class="js" data-trim data-noescape>
								const collection = schema.getCollection('demo')
								const docs = []

								await collection
								  .remove('$.name == "qux"')
								  .execute()

								await collection
								  .find()
								  .execute(doc => doc && docs.push(doc))

								console.log(docs) // [{ name: 'bar' }, { name: 'baz' }]
							</code>
						</pre>
					</section>
					<section id="cnodejs-snippet-transactions">
						<p>Transaction Support</p>
						<pre>
							<code class="js" data-trim data-noescape>
							try {
							  await session.startTransaction()

							  const result = await schema.getCollection('child')
							    .add({ name: 'foo', parent: 'bar' })

							  await schema.getCollection('parent').modify('$._id == "bar"')
							    .arrayAppend('tracking', result.getDocumentId())

							  await session.commit()
							} catch (err) {
							  await session.rollback()
							}
							</code>
						</pre>
					</section>
				</section>
				<section>
					<!-- ~5 minutes -->
					<h2>DEMO</h2>
				</section>
				<section>
					<h2>Links</h2>
					<ul>
						<li><a href="https://dev.mysql.com/doc/refman/8.0/en/document-store.html">https://dev.mysql.com/doc/refman/8.0/en/document-store.html</a></li>
						<li><a href="https://dev.mysql.com/doc/x-devapi-userguide/en/">https://dev.mysql.com/doc/x-devapi-userguide/en/</a></li>
						<li><a href="https://www.npmjs.com/package/@mysql/xdevapi">https://www.npmjs.com/package/@mysql/xdevapi</a></li>
						<li><a href="https://github.com/mysql/mysql-connector-nodejs">https://github.com/mysql/mysql-connector-nodejs</a></li>
						<li><a href="https://dev.mysql.com/doc/dev/connector-nodejs/">https://dev.mysql.com/doc/dev/connector-nodejs/</a></li>
					</ul>
				</section>
				<section>
					<!-- ~5 minutes -->
					<p>Thank You &amp; Pointer to InnoDB Cluster &amp; DocStore Session by Jan</p>
				</section>
				<section>
					<img src="images/dolphin.jpg" style="border:0px;">
				</section>
				<section>
					<h2>Safe Harbor Statement</h2>
					<p>The preceding is intended to outline our general product direction. It is intended for information purposes only, and may not be incorporated into any contract. It is not a commitment to deliver any material, code, or functionality, and should not be relied upon in making purchasing decisions. The development, release, and timing of any features or functionality described for Oracle’s products remains at the sole discretion of Oracle.</p>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});

			Reveal.configure({
				slideNumber: true
			});
		</script>
	</body>
</html>
